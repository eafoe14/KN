var area = document.getElementById('area');
var cell = document.getElementsByClassName('cell');
var currentPlayer = document.getElementById('curPlyr');

var player = "x";
var stat = {
    'x': 0,
    'o': 0,
    'd': 0
}
var winIndex = [
[1,2,3,4,5],
[2,3,4,5,6],
[3,4,5,6,7],
[4,5,6,7,8],
[5,6,7,8,9],
[6,7,8,9,10],
[11,12,13,14,15],
[12,13,14,15,16],
[13,14,15,16,17],
[14,15,16,17,18],
[15,16,17,18,19],
[16,17,18,19,20],
[21,22,23,24,25],
[22,23,24,25,26],
[23,24,25,26,27],
[24,25,26,27,28],
[25,26,27,28,29],
[26,27,28,29,30],
[31,32,33,34,35],
[32,33,34,35,36],
[33,34,35,36,37],
[34,35,36,37,38],
[35,36,37,38,39],
[36,37,38,39,40],
[41,42,43,44,45],
[42,43,44,45,46],
[43,44,45,46,47],
[44,45,46,47,48],
[45,46,47,48,49],
[46,47,48,49,50],
[51,52,53,54,55],
[52,53,54,55,56],
[53,54,55,56,57],
[54,55,56,57,58],
[55,56,57,58,59],
[56,57,58,59,60],
[61,62,63,64,65],
[62,63,64,65,66],
[63,64,65,66,67],
[64,65,66,67,68],
[65,66,67,68,69],
[66,67,68,69,70],
[71,72,73,74,75],
[72,73,74,75,76],
[73,74,75,76,77],
[74,75,76,77,78],
[75,76,77,78,79],
[76,77,78,79,80],
[81,82,83,84,85],
[82,83,84,85,86],
[83,84,85,86,87],
[84,85,86,87,88],
[85,86,87,88,89],
[86,87,88,89,90],
[91,92,93,94,95],
[92,93,94,95,96],
[93,94,95,96,97],
[94,95,96,97,98],
[95,96,97,98,99],
[96,97,98,99,100],
[1,11,21,31,41],
[11,21,31,41,51],
[21,31,41,51,61],
[31,41,51,61,71],
[41,51,61,71,81],
[51,61,71,81,91],
[2,12,22,32,42],
[12,22,32,42,52],
[22,32,42,52,62],
[32,42,52,62,72],
[42,52,62,72,82],
[52,62,72,82,92],
[3,13,23,33,43],
[13,23,33,43,53],
[23,33,43,53,63],
[33,43,53,63,73],
[43,53,63,73,83],
[53,63,73,83,93],
[4,14,24,34,44],
[14,24,34,44,54],
[24,34,44,54,64],
[34,44,54,64,74],
[44,54,64,74,84],
[54,64,74,84,94],
[5,15,25,35,45],
[15,25,35,45,55],
[25,35,45,55,65],
[35,45,55,65,75],
[45,55,65,75,85],
[55,65,75,85,95],
[6,16,26,36,46],
[16,26,36,46,56],
[26,36,46,56,66],
[36,46,56,66,76],
[46,56,66,76,86],
[56,66,76,86,96],
[7,17,27,37,47],
[17,27,37,47,57],
[27,37,47,57,67],
[37,47,57,67,77],
[47,57,67,77,87],
[57,67,77,87,97],
[8,18,28,38,48],
[18,28,38,48,58],
[28,38,48,58,68],
[38,48,58,68,78],
[48,58,68,78,88],
[58,68,78,88,98],
[9,19,29,39,49],
[19,29,39,49,59],
[29,39,49,59,69],
[39,49,59,69,79],
[49,59,69,79,89],
[59,69,79,89,99],
[10,20,30,40,50],
[20,30,40,50,60],
[30,40,50,60,70],
[40,50,60,70,80],
[50,60,70,80,90],
[60,70,80,90,100],
[51,62,73,84,95],
[41,52,63,74,85],
[52,63,74,85,96],
[31,42,53,64,75],
[42,53,64,75,86],
[53,64,75,86,97],
[21,32,43,54,65],
[32,43,54,65,76],
[43,54,65,76,87],
[54,65,76,87,98],
[11,22,33,44,55],
[22,33,44,55,66],
[33,44,55,66,77],
[44,55,66,77,88],
[55,66,77,88,99],
[1,12,23,34,45],
[12,23,34,45,56],
[23,34,45,56,67],
[34,45,56,67,78],
[45,56,67,78,89],
[56,67,78,89,100],
[2,13,24,35,46],
[13,24,35,46,57],
[24,35,46,57,68],
[35,46,57,68,79],
[46,57,68,79,90],
[3,14,25,36,47],
[14,25,36,47,58],
[25,36,47,58,69],
[36,47,58,69,80],
[4,15,26,37,48],
[15,26,37,48,59],
[26,37,48,59,70],
[5,16,27,38,49],
[16,27,38,49,60],
[6,17,28,39,50],
[60,69,48,87,96],
[50,59,68,77,86],
[59,68,77,86,95],
[40,49,58,67,76],
[49,58,67,76,85],
[58,67,76,85,94],
[30,39,48,57,66],
[39,48,57,66,75],
[48,57,66,75,84],
[57,66,75,84,93],
[20,29,38,47,56],
[29,38,47,56,65],
[38,47,56,65,74],
[47,56,65,74,83],
[56,65,74,83,92],
[10,19,28,37,46],
[19,28,37,46,55],
[28,37,46,55,64],
[37,46,55,64,73],
[46,55,64,73,82],
[55,64,73,82,91],
[9,18,27,36,45],
[18,27,36,45,54],
[27,36,45,54,63],
[36,45,54,63,72],
[45,54,63,72,81],
[8,17,26,35,44],
[17,26,35,44,53],
[26,35,44,53,62],
[35,44,53,62,71],
[7,16,25,34,43],
[16,25,34,43,52],
[25,34,43,52,61],
[6,15,24,33,42],
[15,24,33,42,51],
[5,14,23,32,41]
];

var winIndexKvadrat = [
    [1,2,3,13,23,22,21,11],
    [2,3,4,14,24,23,22,12],
    [3,4,5,15,25,24,23,13],
    [4,5,6,16,26,25,24,14],
    [5,6,7,17,27,26,25,15],
    [6,7,8,18,28,27,26,16],
    [7,8,9,19,29,28,27,17],
    [8,9,10,20,30,29,28,18],
    [11,12,13,23,33,32,31,21],
    [12,13,14,24,34,33,32,22],
    [13,14,15,25,35,34,33,23],
    [14,15,16,26,36,35,34,24],
    [15,16,17,27,37,36,35,25],
    [16,17,18,28,38,37,36,26],
    [17,18,19,29,39,38,37,27],
    [18,19,20,30,40,39,38,28],
    [21,22,23,33,43,42,41,31],
    [22,23,24,34,44,43,42,32],
    [23,24,25,35,45,44,43,33],
    [24,25,26,36,46,45,44,34],
    [25,26,27,37,47,46,45,35],
    [26,27,28,38,48,47,46,36],
    [27,28,29,39,49,48,47,37],
    [28,29,30,40,50,49,48,38],
    [31,32,33,43,53,52,51,41],
    [32,33,34,44,54,53,52,42],
    [33,34,35,45,55,54,53,43],
    [34,35,36,46,56,55,54,44],
    [35,36,37,47,57,56,55,45],
    [36,37,38,48,58,57,56,46],
    [37,38,39,49,59,58,57,47],
    [38,39,40,40,60,59,58,48],
    [41,42,43,53,63,62,61,51],
    [42,43,44,54,64,63,62,52],
    [43,44,45,55,65,64,63,53],
    [44,45,46,56,66,65,64,54],
    [45,46,47,57,67,66,65,55],
    [46,47,48,58,68,67,66,56],
    [47,48,49,59,69,68,67,57],
    [48,49,50,60,70,69,68,58],
    [51,52,53,63,73,72,71,61],
    [52,53,54,64,74,73,72,62],
    [53,54,55,65,75,74,73,63],
    [54,55,56,66,76,75,74,64],
    [55,56,57,67,77,76,75,65],
    [56,57,58,68,78,77,76,66],
    [57,58,59,69,79,78,77,67],
    [58,59,60,70,80,79,78,68],
    [61,62,63,73,83,82,81,71],
    [62,63,64,74,84,83,82,72],
    [63,64,65,75,85,84,83,73],
    [64,65,66,76,86,85,84,74],
    [65,66,67,77,87,86,85,75],
    [66,67,68,78,88,87,86,76],
    [67,68,69,79,89,88,87,77],
    [68,69,70,80,90,89,88,78],
    [71,72,73,83,93,92,91,81],
    [72,73,74,84,94,93,92,82],
    [73,74,75,85,95,94,93,83],
    [74,75,76,86,96,95,94,84],
    [75,76,77,87,97,96,95,85],
    [76,77,78,88,98,97,96,86],
    [77,78,79,89,99,98,97,87],
    [78,79,80,90,100,99,98,88]    
];

for(var i = 1; i <= 100; i++) {
    area.innerHTML += "<div class='cell' pos=" + i + "></div>";
}

for (var i = 0; i< cell.length; i++) {
    cell[i].addEventListener('click', cellClick, false);
}

closeErrorPopup();
closePopup(); 

function cellClick() {
    var data = [];

    var isActive = this.classList.contains('active');

    if (!this.innerHTML) {
        if (player === 'x') {
            this.classList.remove('zero');
            this.classList.add('cross');
        } else if (player === 'o') {
            this.classList.remove('cross');
            this.classList.add('zero');
        }
        this.innerHTML = player;

        if (!isActive) {
            this.classList.add('active');
        }
        } else {
            var errorPopup = document.getElementById('error-popup');
            var errorMessage = errorPopup.querySelector('.message');
            errorMessage.innerHTML = 'Ячейка занята';
            errorPopup.style.display = 'block';
            return;
        }

    for(var i in cell){
        if(cell[i].innerHTML == player){
            data.push(parseInt(cell[i].getAttribute('pos')));
        }
    }

    if(checkWin(data)) {
        stat[player] += 1;
        restart("Выйграл: " + player);
    }else {
        var draw = true;
        for(var i in cell) {
            if(cell[i].innerHTML == '') draw = false;
        }
        if(draw) {
            stat.d += 1;
            restart("Ничья");
        }
    }

    if(checkWinKvadrat(data)) {
        stat[player] += 2;
        restart("Собран квадрат. + 2 балла. Выйграл: " + player);
    }else {
        var draw = true;
        for(var i in cell) {
            if(cell[i].innerHTML == '') draw = false;
        }
        if(draw) {
            stat.d += 1;
            restart("Ничья");
        }
    }

    player = player == "x" ? "o" : "x";
    currentPlayer.innerHTML = player.toUpperCase();
    currentPlayer.className = "player-" + player;
}

function checkWin(data) {
    for(var i in winIndex) {
        var win = true;
        for(var j in winIndex[i]) {
            var id = winIndex[i][j];
            var ind = data.indexOf(id);

            if(ind == -1) {
                win = false
            }
        }

        if(win) return true;
    }
    return false;
}

function checkWinKvadrat(data) {
    for(var i in winIndexKvadrat) {
        var win = true;
        for(var j in winIndexKvadrat[i]) {
            var id = winIndexKvadrat[i][j];
            var ind = data.indexOf(id);

            if(ind == -1) {
                win = false
            }
        }

        if(win) return true;
    }
    return false;
}

function restart(text) {
    var popup = document.getElementById('popup');
    var message = popup.querySelector('.message');
    message.innerHTML = text;
    popup.style.display = 'block';
}

function resetCells() {
    for(var i = 0; i < cell.length; i++) {
        cell[i].innerHTML = '';
        cell[i].classList.remove('active');
        cell[i].classList.remove('cross');
        cell[i].classList.remove('zero');
    }
}

function closePopup() {
    var popup = document.getElementById('popup');
    popup.style.display = 'none';
    resetCells();
    updateStat();
}

function updateStat() {
    document.getElementById('sX').innerHTML = stat.x;
    document.getElementById('sO').innerHTML = stat.o;
    document.getElementById('sD').innerHTML = stat.d;
}

function closeErrorPopup() {
    var errorPopup = document.getElementById('error-popup');
    errorPopup.style.display = 'none';
}